# AI åŠ©æ‰‹åŠŸèƒ½å¼€å‘æŒ‡å—

> åŸºäº Nuxt 3 + Supabase + é˜¿é‡Œäº‘ç™¾ç‚¼çš„å…¨æ ˆ RAG AI å®¢æœç³»ç»Ÿ

## ç›®å½•

- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [è‡ªåŠ¨åŒ–å‘é‡åŒ–](#è‡ªåŠ¨åŒ–å‘é‡åŒ–-edge-function)
- [åº”ç”¨å±‚å®ç°](#åº”ç”¨å±‚å®ç°-nuxt-3)
- [è¸©å‘å®å½•](#è¸©å‘å®å½•)
- [éƒ¨ç½²æ¸…å•](#éƒ¨ç½²æ¸…å•)

---

## æ ¸å¿ƒæ¶æ„

æ•´ä¸ª AI ç³»ç»Ÿåˆ†ä¸ºä¸¤æ¡æ•°æ®æµï¼š

### 1. è‡ªåŠ¨åŒ–å‘é‡åŒ– (ETL)

```
ç®¡ç†å‘˜æ›´æ–°äº§å“ â†’ Supabase Webhook â†’ Edge Function â†’ ç”Ÿæˆå‘é‡ â†’ å­˜å…¥æ•°æ®åº“
```

**ç›®çš„**ï¼šä¿è¯ AI å§‹ç»ˆåŸºäºæœ€æ–°çš„äº§å“ä¿¡æ¯å›ç­”é—®é¢˜ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

### 2. å¯¹è¯æ£€ç´¢ (RAG)

```
ç”¨æˆ·æé—® â†’ è½¬å‘é‡ â†’ ç›¸ä¼¼åº¦æœç´¢ â†’ ç»„è£… Prompt â†’ LLM ç”Ÿæˆ â†’ æµå¼è¿”å›
```

---

## æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| **å‰ç«¯æ¡†æ¶** | Nuxt 3 | Vue 3 SSR æ¡†æ¶ |
| **æ•°æ®åº“** | Supabase | PostgreSQL + pgvector æ‰©å±• |
| **å¤§æ¨¡å‹** | é˜¿é‡Œäº‘é€šä¹‰åƒé—® | Qwen-Plus (ä¾¿å®œã€ä¸­æ–‡å‹å¥½) |
| **å‘é‡æ¨¡å‹** | é˜¿é‡Œäº‘ text-embedding-v3 | **1024 ç»´** (æ³¨æ„ä¸æ˜¯ 1536) |
| **çŠ¶æ€ç®¡ç†** | Pinia | ç”¨äºç®¡ç†å¤šä¼šè¯çŠ¶æ€ã€æ¶ˆæ¯å†å²å’ŒæŒä¹…åŒ– |
| **AI SDK** | Vercel AI SDK v3 | `ai` + `@ai-sdk/openai` |
| **Markdown** | useSafeMarkdown | åŸºäº marked + DOMPurify çš„å®‰å…¨æ¸²æŸ“ç»„ä»¶ |

---

## æ•°æ®åº“è®¾è®¡

### 1. å¯ç”¨å‘é‡æ‰©å±•

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
create extension if not exists vector;
```

### 2. åˆ›å»ºå‘é‡è¡¨

**è®¾è®¡æ€è·¯**ï¼šä¸ç›´æ¥ä¿®æ”¹åŸæœ‰çš„ `products` è¡¨ï¼Œè€Œæ˜¯åˆ›å»ºå…³è”è¡¨ `product_embeddings`ã€‚

```sql
create table public.product_embeddings (
  id bigint generated by default as identity primary key,
  product_id bigint references public.products(id) on delete cascade,
  content text, -- æ¸…æ´—åçš„è‡ªç„¶è¯­è¨€æ–‡æœ¬ï¼Œç»™ AI ç†è§£
  embedding vector(1024), -- é€‚é…é˜¿é‡Œäº‘ text-embedding-v3 (1024ç»´)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿæœç´¢
create index idx_product_embeddings_embedding_idx
  on public.product_embeddings
  using ivf (embedding vector_cosine_ops)
  with (lists = 100);
```

### 3. åˆ›å»ºå‘é‡æœç´¢å‡½æ•° (RPC)

è¿™ä¸ªå‡½æ•°ä¼šè¢« Nuxt åç«¯è°ƒç”¨æ¥æ£€ç´¢ç›¸å…³äº§å“ã€‚

```sql
create or replace function match_products (
  query_embedding vector(1024),
  match_threshold float default 0.5,
  match_count int default 5
)
returns table (
  id bigint,
  content text,
  similarity float,
  product_details jsonb
)
language plpgsql
as $$
begin
  return query
  select
    products.id,
    product_embeddings.content,
    1 - (product_embeddings.embedding <=> query_embedding) as similarity,
    to_jsonb(products.*) as product_details
  from product_embeddings
  inner join products on products.id = product_embeddings.product_id
  where 1 - (product_embeddings.embedding <=> query_embedding) > match_threshold
    and products.status = 'published'
  order by product_embeddings.embedding <=> query_embedding
  limit match_count;
end;
$$;

-- æˆæƒç»™ service_role
grant execute on function match_products to service_role;
```

---

## è‡ªåŠ¨åŒ–å‘é‡åŒ– (Edge Function)

ä¸ºäº†å®ç°"æ›´æ–°äº§å“è‡ªåŠ¨åŒæ­¥å‘é‡"ï¼Œæˆ‘ä»¬ä½¿ç”¨ Supabase Edge Functionã€‚

### åŠŸèƒ½è¯´æ˜

å½“ `products` è¡¨å‘ç”Ÿ `INSERT` æˆ– `UPDATE` æ—¶ï¼š
1. Webhook è‡ªåŠ¨è§¦å‘ Edge Function
2. Function æ¸…æ´— JSON æ•°æ®ä¸ºè‡ªç„¶è¯­è¨€
3. è°ƒç”¨é˜¿é‡Œäº‘ API ç”Ÿæˆå‘é‡
4. å†™å…¥ `product_embeddings` è¡¨

### ä»£ç å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`supabase/functions/embed-product/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { OpenAI } from 'https://esm.sh/openai@4.42.0'

serve(async (req) => {
  try {
    const { record, type } = await req.json()

    // DELETE æ“ä½œè·³è¿‡
    if (type === 'DELETE' || !record) {
      return new Response('Skipped', { status: 200 })
    }

    // 1. æ•°æ®æ¸…æ´—ï¼šJSON â†’ è‡ªç„¶è¯­è¨€
    const name = record.name?.cn || record.name?.hk || record.name?.en || 'æœªçŸ¥äº§å“'
    const specs = JSON.stringify(record.specs || {})
    const desc = record.description?.cn || record.description?.en || ''

    const content = `äº§å“åç§°: ${name}\nè§„æ ¼å‚æ•°: ${specs}\näº§å“æè¿°: ${desc}`

    // 2. è°ƒç”¨é˜¿é‡Œäº‘ç”Ÿæˆå‘é‡
    const openai = new OpenAI({
      apiKey: Deno.env.get('DASHSCOPE_API_KEY'),
      baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
    })

    const embedding = await openai.embeddings.create({
      model: 'text-embedding-v3',
      input: content.replace(/\n/g, ' '),
      dimensions: 1024,
    })

    // 3. å†™å…¥æ•°æ®åº“
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )

    await supabase.from('product_embeddings').upsert({
      product_id: record.id,
      content: content,
      embedding: embedding.data[0].embedding,
    })

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
    })

  } catch (error) {
    console.error('Embedding error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

### éƒ¨ç½²æ­¥éª¤

1. **åœ¨ Supabase é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ç¯å¢ƒå˜é‡**ï¼š
   - `DASHSCOPE_API_KEY`: ä½ çš„é˜¿é‡Œäº‘ API Key
   - `SUPABASE_URL`: é¡¹ç›® URL
   - `SUPABASE_SERVICE_ROLE_KEY`: Service Role Key

2. **éƒ¨ç½² Function**ï¼š
   ```bash
   supabase functions deploy embed-product
   ```

3. **é…ç½® Webhook**ï¼š
   - è¿›å…¥ Supabase Dashboard â†’ Database â†’ Webhooks
   - åˆ›å»ºæ–° Webhookï¼Œç›‘å¬ `products` è¡¨çš„ `INSERT` å’Œ `UPDATE`
   - ç›®æ ‡ URL: `https://your-project.supabase.co/functions/v1/embed-product`
   - ç¡®ä¿å‹¾é€‰ "Send only changed columns"

---

## åº”ç”¨å±‚å®ç° (Nuxt 3)

### 1. ç¯å¢ƒå˜é‡é…ç½®

**`.env` æ–‡ä»¶**ï¼š
```env
# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
SUPABASE_SECRET_KEY=your_supabase_service_role_key

# é˜¿é‡Œäº‘ç™¾ç‚¼
DASHSCOPE_API_KEY=your_dashscope_api_key
```

**`nuxt.config.ts` é…ç½®**ï¼š
```typescript
export default defineNuxtConfig({
  runtimeConfig: {
    // æœåŠ¡ç«¯ç§æœ‰é…ç½®
    dashscopeApiKey: process.env.DASHSCOPE_API_KEY,
    supabaseService: {
      url: process.env.SUPABASE_URL,
      key: process.env.SUPABASE_SECRET_KEY,
    },
    // å‰ç«¯å…¬å¼€é…ç½®
    public: {
      supabaseUrl: process.env.SUPABASE_URL,
      supabaseKey: process.env.SUPABASE_KEY,
    },
  },
})
```

### 2. åç«¯ API å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`server/api/ai-chat.ts`

```typescript
import { createOpenAI } from '@ai-sdk/openai'
import { streamText } from 'ai'
import { OpenAI } from 'openai'
import { createClient } from '@supabase/supabase-js'

export default defineEventHandler(async (event) => {
  const config = useRuntimeConfig()
  const { url, key } = config.supabaseService
  const apiKey = config.dashscopeApiKey

  if (!url || !key || !apiKey) {
    throw createError({ statusCode: 500, statusMessage: 'Missing AI Configuration' })
  }

  // åˆå§‹åŒ–å®¢æˆ·ç«¯
  const supabaseAdmin = createClient(url, key)
  const aliyun = createOpenAI({
    apiKey: apiKey,
    baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
  })
  const openaiForEmbed = new OpenAI({
    apiKey: apiKey,
    baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
  })

  // è§£æç”¨æˆ·è¾“å…¥
  const { messages } = await readBody(event)
  const lastMessage = messages[messages.length - 1].content

  try {
    // 1. ç”Ÿæˆé—®é¢˜å‘é‡
    const embeddingResp = await openaiForEmbed.embeddings.create({
      model: 'text-embedding-v3',
      input: lastMessage.replaceAll('\n', ' '),
      dimensions: 1024,
    })

    // 2. å‘é‡æœç´¢
    const { data: products } = await supabaseAdmin.rpc('match_products', {
      query_embedding: embeddingResp.data[0].embedding,
      match_threshold: 0.5,
      match_count: 5,
    })

    // 3. æ„å»ºä¸Šä¸‹æ–‡
    const contextBlock = products?.map((item: any) => {
      const raw = item.product_details
      const name = raw.name?.cn || raw.name?.hk || raw.name?.en || 'æœªå‘½åäº§å“'
      return `[äº§å“]: ${name}\n[AIæ‘˜è¦]: ${item.content}\n---`
    }).join('\n') || 'æœªæ‰¾åˆ°ç›¸å…³äº§å“'

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ç¡¬ä»¶ä¸“å®¶ (Supercore AI)ã€‚
è¯·åŸºäºä»¥ä¸‹äº§å“åº“å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœåº“é‡Œæ²¡æœ‰ï¼Œè¯·è¯´æ˜ã€‚
è¯·ç”¨ç¹ä½“ä¸­æ–‡(é¦™æ¸¯)æˆ–ç”¨æˆ·ä½¿ç”¨çš„è¯­è¨€å›ç­”ã€‚

ã€äº§å“åº“æ•°æ®ã€‘:
${contextBlock}`

    // 4. æµå¼ç”Ÿæˆ
    const result = await streamText({
      model: aliyun('qwen-plus'),
      messages: [
        { role: 'system', content: systemPrompt },
        ...messages,
      ],
      temperature: 0.3,
    })

    return result.toDataStreamResponse()

  } catch (e: any) {
    console.error('AI Chat Error:', e)
    throw createError({ statusCode: 500, statusMessage: e.message })
  }
})

### 3. å‰ç«¯ç»„ä»¶

**çŠ¶æ€ç®¡ç†** (`stores/chat.ts`)
- Pinia Store å¤„ç†ä¼šè¯åˆ—è¡¨åŒæ­¥
- è‡ªåŠ¨å¤„ç†ä¼šè¯åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤å’Œé‡å‘½å
- æ¶ˆæ¯å†å²è®°å½•ç®¡ç†

**å‰ç«¯ç»„ä»¶** (`components/ui/AiChat.vue`)
- é›†æˆ `useChatStore` ç»Ÿä¸€ç®¡ç†çŠ¶æ€
- Vercel AI SDK çš„ `useChat` hook å¤„ç†æµå¼è®¡ç®—
- Swiss Design é£æ ¼ UIï¼Œæ”¯æŒå¤šä¼šè¯ä¾§æ 
- `useSafeMarkdown` å®‰å…¨æ¸²æŸ“ Markdown å†…å®¹
- è‡ªåŠ¨æ»šåŠ¨ã€åŠ è½½åŠ¨ç”»ã€äº¤äº’åé¦ˆ

```vue
<script setup lang="ts">
import { useChat } from 'ai/vue'
import { ref, watch, nextTick } from 'vue'
import { marked } from 'marked'

const isOpen = ref(false)
const scrollContainer = ref<HTMLDivElement | null>(null)

const { messages, input, handleSubmit, isLoading } = useChat({
  api: '/api/ai-chat'
})

marked.setOptions({ breaks: true, gfm: true })

// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
watch(messages, async () => {
  await nextTick()
  if (scrollContainer.value) {
    scrollContainer.value.scrollTop = scrollContainer.value.scrollHeight
  }
}, { deep: true })
</script>

<template>
  <div class="fixed bottom-6 right-6 z-50">
    <!-- Chat Window -->
    <div v-if="isOpen" class="w-[350px] h-[500px] bg-white rounded-xl shadow-xl flex flex-col">
      <!-- Header -->
      <div class="p-4 bg-blue-600 text-white flex justify-between">
        <span>Supercore AI</span>
        <button @click="isOpen = false">âœ•</button>
      </div>

      <!-- Messages -->
      <div ref="scrollContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div v-for="m in messages" :key="m.id"
             :class="['p-3 rounded-lg max-w-[85%]',
                      m.role === 'user' ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-100 mr-auto']">
          <div v-if="m.role === 'assistant'" v-html="marked(m.content)" />
          <div v-else>{{ m.content }}</div>
        </div>
      </div>

      <!-- Input -->
      <form @submit="handleSubmit" class="p-3 border-t flex gap-2">
        <input v-model="input" placeholder="è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ï¼Ÿ" />
        <button type="submit" :disabled="isLoading">Send</button>
      </form>
    </div>

    <!-- Toggle Button -->
    <button @click="isOpen = !isOpen">ğŸ’¬</button>
  </div>
</template>
```

---

## è¸©å‘å®å½•

### å‘ 1ï¼šNuxt "å¹½çµæŠ¥é”™" (`replace` of undefined)

**ç°è±¡**ï¼š
ä¿®æ”¹ `.env` æˆ– `nuxt.config.ts` åï¼Œé¡µé¢ç™½å±ï¼Œæ§åˆ¶å°æŠ¥é”™ï¼š
```
Cannot read properties of undefined (reading 'replace')
```

**åŸå› **ï¼š
Nuxt çš„é”™è¯¯é¡µé¢æ¸²æŸ“å™¨ (`youch`) å› ç¼“å­˜é—®é¢˜å´©æºƒäº†ã€‚

**è§£å†³**ï¼š
```bash
# 1. åœæ­¢æœåŠ¡
# 2. åˆ é™¤ç¼“å­˜
rm -rf .nuxt
rm -rf node_modules/.cache

# 3. é‡å¯
npm run dev
```

### å‘ 2ï¼šç‰ˆæœ¬ä¾èµ–åœ°ç‹±

**ç°è±¡**ï¼š
`import { useChat } from 'ai/vue'` æŠ¥é”™æ‰¾ä¸åˆ°æ¨¡å—ã€‚

**åŸå› **ï¼š
Vercel AI SDK æ›´æ–°æå¿«ï¼Œv3 å’Œ v4 API ä¸å…¼å®¹ã€‚

**è§£å†³**ï¼š
é”å®šç‰ˆæœ¬ä½¿ç”¨ `ai` (3.x)ï¼š
```json
{
  "dependencies": {
    "ai": "^3.1.37",
    "@ai-sdk/openai": "^1.0.0",
    "openai": "^4.42.0"
  }
}
```

### å‘ 3ï¼šSupabase è·¯ç”±æ‹¦æˆª

**ç°è±¡**ï¼š
API æ¥å£åœ¨ Postman èƒ½é€šï¼Œä½†æµè§ˆå™¨è°ƒç”¨è¿”å› 302 æˆ– HTMLã€‚

**åŸå› **ï¼š
`@nuxtjs/supabase` æ¨¡å—å¼€å¯äº†å…¨å±€è·¯ç”±ä¿æŠ¤ï¼Œæœªç™»å½•ç”¨æˆ·è¢«æ‹¦æˆªã€‚

**è§£å†³**ï¼š
åœ¨ `nuxt.config.ts` ä¸­æ·»åŠ ç™½åå•ï¼š
```typescript
supabase: {
  redirectOptions: {
    exclude: [
      '/api/ai-chat',
      '/api/products/public',
      // å…¶ä»–å…¬å¼€ API...
    ]
  }
}
```

### å‘ 4ï¼šå‘é‡ç»´åº¦é”™è¯¯

**ç°è±¡**ï¼š
æ’å…¥å‘é‡æ—¶æŠ¥é”™ `vector dimension must be 1024`ã€‚

**åŸå› **ï¼š
é˜¿é‡Œäº‘ `text-embedding-v3` ç”Ÿæˆçš„æ˜¯ 1024 ç»´å‘é‡ï¼Œä¸æ˜¯ OpenAI çš„ 1536 ç»´ã€‚

**è§£å†³**ï¼š
ç¡®ä¿æ•°æ®åº“è¡¨å’Œå‡½æ•°éƒ½ä½¿ç”¨ `vector(1024)`ã€‚

---

## éƒ¨ç½²æ¸…å•

### æœ¬åœ°å¼€å‘

1. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   npm install
   ```

2. **é…ç½® `.env`**ï¼š
   ```env
   SUPABASE_URL=xxx
   SUPABASE_KEY=xxx
   SUPABASE_SECRET_KEY=xxx
   DASHSCOPE_API_KEY=xxx
   ```

3. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**ï¼š
   ```bash
   npm run dev
   ```

### ç”Ÿäº§éƒ¨ç½²

1. **éƒ¨ç½² Edge Function**ï¼š
   ```bash
   supabase functions deploy embed-product
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆåœ¨éƒ¨ç½²å¹³å°ï¼‰ï¼š
   - `SUPABASE_URL`
   - `SUPABASE_KEY`
   - `SUPABASE_SECRET_KEY`
   - `DASHSCOPE_API_KEY`

3. **æ„å»ºå¹¶éƒ¨ç½²**ï¼š
   ```bash
   npm run build
   # éƒ¨ç½²åˆ° Vercel / Netlify ç­‰
   ```

---

## æ€»ç»“

è¿™å¥—æ¶æ„éå¸¸é€‚åˆä¸ªäººå¼€å‘è€…æˆ–ä¸­å°é¡¹ç›®ï¼š

âœ… **æˆæœ¬ä½**ï¼šSupabase å…è´¹é¢åº¦ + é˜¿é‡Œç™¾ç‚¼æ¯” OpenAI ä¾¿å®œ 70%+

âœ… **è‡ªåŠ¨åŒ–**ï¼šé€šè¿‡ Edge Function å®ç°æ•°æ®åŒæ­¥è‡ªåŠ¨åŒ–

âœ… **å¼€å‘ä½“éªŒ**ï¼šNuxt 3 å…¨æ ˆå¼€å‘é¡ºæ»‘ï¼ŒTypeScript ç±»å‹å®‰å…¨

âš ï¸ **æ³¨æ„ç‚¹**ï¼š
- é…ç½®æ–‡ä»¶æ”¹åŠ¨åè®°å¾—æ¸…ç¼“å­˜
- ç‰ˆæœ¬ä¾èµ–è¦é”å®šï¼Œé¿å…è‡ªåŠ¨å‡çº§
- API è·¯ç”±è¦åŠ å…¥ Supabase ç™½åå•

---

**å‚è€ƒèµ„æº**ï¼š
- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [é˜¿é‡Œäº‘ç™¾ç‚¼æ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)
- [pgvector æ–‡æ¡£](https://github.com/pgvector/pgvector)
