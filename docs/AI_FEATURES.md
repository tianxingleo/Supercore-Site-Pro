# AI åŠ©æ‰‹åŠŸèƒ½å¼€å‘æŒ‡å—

> åŸºäº Nuxt 3 + Supabase + é˜¿é‡Œäº‘ç™¾ç‚¼çš„å…¨æ ˆ RAG AI å®¢æœç³»ç»Ÿ

## ç›®å½•

- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [è‡ªåŠ¨åŒ–å‘é‡åŒ–](#è‡ªåŠ¨åŒ–å‘é‡åŒ–-edge-function)
- [åº”ç”¨å±‚å®ç°](#åº”ç”¨å±‚å®ç°-nuxt-3)
- [è¸©å‘å®å½•](#è¸©å‘å®å½•)
- [éƒ¨ç½²æ¸…å•](#éƒ¨ç½²æ¸…å•)

---

## æ ¸å¿ƒæ¶æ„

æ•´ä¸ª AI ç³»ç»Ÿåˆ†ä¸ºä¸¤æ¡æ•°æ®æµï¼š

### 1. è‡ªåŠ¨åŒ–å‘é‡åŒ– (ETL)

```
ç®¡ç†å‘˜æ›´æ–°äº§å“ â†’ Supabase Webhook â†’ Edge Function â†’ ç”Ÿæˆå‘é‡ â†’ å­˜å…¥æ•°æ®åº“
```

**ç›®çš„**ï¼šä¿è¯ AI å§‹ç»ˆåŸºäºæœ€æ–°çš„äº§å“ä¿¡æ¯å›ç­”é—®é¢˜ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

### 2. å¯¹è¯æ£€ç´¢ (RAG)

```
ç”¨æˆ·æé—® â†’ è½¬å‘é‡ â†’ ç›¸ä¼¼åº¦æœç´¢ â†’ ç»„è£… Prompt â†’ LLM ç”Ÿæˆ â†’ æµå¼è¿”å›
```

---

## æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| **å‰ç«¯æ¡†æ¶** | Nuxt 3 | Vue 3 SSR æ¡†æ¶ |
| **æ•°æ®åº“** | Supabase | PostgreSQL + pgvector æ‰©å±• |
| **å¤§æ¨¡å‹** | é˜¿é‡Œäº‘é€šä¹‰åƒé—® | Qwen-Plus (ä¾¿å®œã€ä¸­æ–‡å‹å¥½) |
| **å‘é‡æ¨¡å‹** | é˜¿é‡Œäº‘ text-embedding-v3 | **1024 ç»´** (æ³¨æ„ä¸æ˜¯ 1536) |
| **çŠ¶æ€ç®¡ç†** | Pinia | ç”¨äºç®¡ç†å¤šä¼šè¯çŠ¶æ€ã€æ¶ˆæ¯å†å²å’ŒæŒä¹…åŒ– |
| **AI SDK** | Vercel AI SDK v3 | `ai` + `@ai-sdk/openai` |
| **Markdown** | useSafeMarkdown | åŸºäº marked + DOMPurify çš„å®‰å…¨æ¸²æŸ“ç»„ä»¶ |
| **åŒ¿åè¯†åˆ«** | useAnonymousUser | åŸºäº FPJS çš„æµè§ˆå™¨æŒ‡çº¹è¯†åˆ«ï¼Œç®¡ç† `anonymous_user_id` |
| **Token ç®¡ç†** | checkUsageLimit | æœåŠ¡ç«¯ Token æ¶ˆè€—ä¼°ç®—ä¸æ¯æ—¥é¢åº¦é™åˆ¶ (é»˜è®¤ 10k) |
| **æ•°æ®å¯è§†åŒ–** | ECharts | ç”¨äºç®¡ç†åå° AI ç»Ÿè®¡å›¾è¡¨å±•ç¤º |

---

## æ•°æ®åº“è®¾è®¡

### è®¾è®¡åŸåˆ™

æ•´ä¸ªæ•°æ®åº“é‡‡ç”¨ **Supabase (PostgreSQL + pgvector)** ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šä¸ç›´æ¥ä¿®æ”¹ä¸šåŠ¡è¡¨ï¼Œè€Œæ˜¯é€šè¿‡å…³è”è¡¨æ‰©å±•åŠŸèƒ½ï¼ˆå¦‚ `product_embeddings`ï¼‰
2. **åŒ¿åç”¨æˆ·æ”¯æŒ**ï¼šä½¿ç”¨ `anonymous_user_id` å­—æ®µæ”¯æŒæœªç™»å½•ç”¨æˆ·çš„ä¼šè¯è¿½è¸ª
3. **è½¯åˆ é™¤**ï¼šé‡è¦æ•°æ®ä½¿ç”¨ `deleted_at` å­—æ®µå®ç°è½¯åˆ é™¤ï¼Œä¾¿äºæ•°æ®æ¢å¤
4. **åŒ ID è®¾è®¡**ï¼šåŒæ—¶æ”¯æŒ `auth.users.id` å’Œ `anonymous_user_id`ï¼Œé€‚åº”ä¸åŒç”¨æˆ·ç±»å‹
5. **å‘é‡æœç´¢**ï¼šä½¿ç”¨ pgvector æ‰©å±•å®ç°é«˜æ•ˆçš„ç›¸ä¼¼åº¦æœç´¢

---

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. å¯ç”¨å‘é‡æ‰©å±•

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
create extension if not exists vector;
```

---

#### 2. å¯¹è¯ç³»ç»Ÿè¡¨ (Chat System)

##### 2.1 chat_sessions - ä¼šè¯è¡¨

å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„èŠå¤©ä¼šè¯ï¼ˆåŒ…æ‹¬åŒ¿åç”¨æˆ·ï¼‰ã€‚

```sql
create table public.chat_sessions (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,        -- ç™»å½•ç”¨æˆ· ID
  anonymous_user_id varchar(255),                                   -- åŒ¿åç”¨æˆ·æŒ‡çº¹ ID
  title varchar(500) default 'æ–°å¯¹è¯',                              -- ä¼šè¯æ ‡é¢˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ï¼‰
  model varchar(50) default 'qwen-plus',                            -- ä½¿ç”¨çš„æ¨¡å‹
  language varchar(10) default 'zh-HK',                             -- ä¼šè¯è¯­è¨€
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  deleted_at timestamp with time zone,                              -- è½¯åˆ é™¤æ—¶é—´æˆ³

  -- çº¦æŸï¼šè‡³å°‘æœ‰ä¸€ä¸ªç”¨æˆ·æ ‡è¯†ç¬¦
  constraint chat_sessions_user_check check (
    (user_id is not null and anonymous_user_id is null) or
    (user_id is null and anonymous_user_id is not null)
  )
);

-- ç´¢å¼•ï¼šåŠ é€Ÿç”¨æˆ·ä¼šè¯æŸ¥è¯¢
create index idx_chat_sessions_user_id on public.chat_sessions(user_id);
create index idx_chat_sessions_anonymous_id on public.chat_sessions(anonymous_user_id);
create index idx_chat_sessions_deleted_at on public.chat_sessions(deleted_at);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **åŒ ID è®¾è®¡**ï¼šåŒæ—¶æ”¯æŒç™»å½•ç”¨æˆ·å’ŒåŒ¿åç”¨æˆ·ï¼Œç¡®ä¿æ‰€æœ‰å¯¹è¯éƒ½å¯è¿½æº¯
- **è‡ªåŠ¨æ ‡é¢˜**ï¼šæ–°ä¼šè¯é»˜è®¤æ ‡é¢˜ä¸º"æ–°å¯¹è¯"ï¼Œå¯é€šè¿‡ AI æˆ–ç”¨æˆ·ä¿®æ”¹
- **è½¯åˆ é™¤**ï¼šä½¿ç”¨ `deleted_at` å®ç°è½¯åˆ é™¤ï¼Œä¿ç•™å†å²æ•°æ®ä¾¿äºåˆ†æ

##### 2.2 chat_messages - æ¶ˆæ¯è¡¨

å­˜å‚¨æ¯æ¡å¯¹è¯æ¶ˆæ¯ï¼Œå…³è”åˆ°å…·ä½“ä¼šè¯ã€‚

```sql
create table public.chat_messages (
  id bigint generated by default as identity primary key,
  session_id bigint references public.chat_sessions(id) on delete cascade,
  role varchar(20) not null check (role in ('user', 'assistant', 'system')),
  content text not null,
  tokens_estimate int,                                             -- Token ä¼°ç®—
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,

  constraint chat_messages_role_check check (role in ('user', 'assistant', 'system'))
);

-- ç´¢å¼•ï¼šåŠ é€Ÿæ¶ˆæ¯æŸ¥è¯¢
create index idx_chat_messages_session_id on public.chat_messages(session_id);
create index idx_chat_messages_created_at on public.chat_messages(created_at desc);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **è§’è‰²éªŒè¯**ï¼šä½¿ç”¨ CHECK çº¦æŸç¡®ä¿åªæœ‰æœ‰æ•ˆè§’è‰²ï¼ˆuser/assistant/systemï¼‰
- **Token è¿½è¸ª**ï¼š`tokens_estimate` å­—æ®µç”¨äºæˆæœ¬ç»Ÿè®¡å’Œé™é¢æ§åˆ¶
- **æ—¶é—´æ’åº**ï¼šé€šè¿‡ `created_at` ç´¢å¼•ä¼˜åŒ–æ¶ˆæ¯æ—¶é—´çº¿æŸ¥è¯¢

##### 2.3 chat_feedback - ç”¨æˆ·åé¦ˆè¡¨

æ”¶é›†ç”¨æˆ·å¯¹ AI å›ç­”çš„è´¨é‡è¯„åˆ†ï¼Œç”¨äºæ”¹è¿›æ¨¡å‹ã€‚

```sql
create table public.chat_feedback (
  id bigint generated by default as identity primary key,
  message_id bigint references public.chat_messages(id) on delete cascade,
  rating int check (rating >= 1 and rating <= 5),                 -- 1-5 æ˜Ÿè¯„åˆ†
  category varchar(50),                                            -- åé¦ˆç±»åˆ«ï¼ˆå¦‚ 'incorrect', 'unclear'ï¼‰
  comment text,                                                    -- ç”¨æˆ·è¯„è®º
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ç´¢å¼•
create index idx_chat_feedback_message_id on public.chat_feedback(message_id);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **è´¨é‡è¿½è¸ª**ï¼šé€šè¿‡ 5 æ˜Ÿè¯„åˆ†é‡åŒ– AI å›ç­”è´¨é‡
- **åˆ†ç±»åé¦ˆ**ï¼šæ”¯æŒæŒ‰ç±»åˆ«ï¼ˆå¦‚ä¸å‡†ç¡®ã€ä¸æ¸…æ¥šï¼‰ç»Ÿè®¡é—®é¢˜ç±»å‹
- **æ•°æ®é©±åŠ¨æ”¹è¿›**ï¼šå¯ç”¨äºè®­ç»ƒæ•°æ®ç­›é€‰å’Œ prompt ä¼˜åŒ–

##### 2.4 chat_suggestions - æ™ºèƒ½å»ºè®®è¡¨

å­˜å‚¨ AI ç”Ÿæˆçš„å»ºè®®é—®é¢˜æˆ–å¿«æ·å›å¤ã€‚

```sql
create table public.chat_suggestions (
  id bigint generated by default as identity primary key,
  session_id bigint references public.chat_sessions(id) on delete cascade,
  suggestion text not null,
  context varchar(100),                                            -- å»ºè®®åœºæ™¯ï¼ˆå¦‚ 'greeting', 'product_query'ï¼‰
  display_order int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ç´¢å¼•
create index idx_chat_suggestions_session_id on public.chat_suggestions(session_id);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **åœºæ™¯åŒ–å»ºè®®**ï¼šæ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡æä¾›ç›¸å…³é—®é¢˜
- **ä¸ªæ€§åŒ–æ¨è**ï¼šåŸºäºç”¨æˆ·å†å²è¡Œä¸ºä¼˜åŒ–å»ºè®®å†…å®¹
- **æå‡è½¬åŒ–ç‡**ï¼šå¼•å¯¼ç”¨æˆ·æ¢ç´¢äº§å“åŠŸèƒ½æˆ–è§£å†³æ–¹æ¡ˆ

##### 2.5 ai_usage_stats - AI ä½¿ç”¨ç»Ÿè®¡è¡¨

è¿½è¸ªæ¯ä¸ªç”¨æˆ·çš„ Token ä½¿ç”¨é‡ï¼Œç”¨äºæˆæœ¬æ§åˆ¶å’Œé™é¢ç®¡ç†ã€‚

```sql
create table public.ai_usage_stats (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  anonymous_user_id varchar(255),
  date date not null default current_date,
  total_tokens int default 0,
  message_count int default 0,
  session_count int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,

  -- å”¯ä¸€çº¦æŸï¼šæ¯ä¸ªç”¨æˆ·æ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
  constraint ai_usage_stats_unique unique (user_id, anonymous_user_id, date)
);

-- ç´¢å¼•
create index idx_ai_usage_stats_user_id on public.ai_usage_stats(user_id);
create index idx_ai_usage_stats_anonymous_id on public.ai_usage_stats(anonymous_user_id);
create index idx_ai_usage_stats_date on public.ai_usage_stats(date);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **æ¯æ—¥é™é¢**ï¼šé€šè¿‡ `date` å­—æ®µå®ç°æ¯æ—¥ Token é¢åº¦æ§åˆ¶ï¼ˆé»˜è®¤ 10kï¼‰
- **æˆæœ¬ç®¡ç†**ï¼šç»Ÿè®¡æ¶ˆæ¯æ•°å’Œä¼šè¯æ•°ï¼Œç”¨äºè´¢åŠ¡åˆ†æ
- **é˜²æ»¥ç”¨**ï¼šå¼‚å¸¸é«˜é¢‘è¯·æ±‚è‡ªåŠ¨è§¦å‘é™æµæœºåˆ¶

---

#### 3. å‘é‡æœç´¢è¡¨ (Vector Search)

##### 3.1 product_embeddings - äº§å“å‘é‡è¡¨

å­˜å‚¨äº§å“çš„å‘é‡åŒ–è¡¨ç¤ºï¼Œç”¨äºè¯­ä¹‰æœç´¢ã€‚

```sql
create table public.product_embeddings (
  id bigint generated by default as identity primary key,
  product_id bigint references public.products(id) on delete cascade,
  content text,                                                    -- æ¸…æ´—åçš„è‡ªç„¶è¯­è¨€æ–‡æœ¬
  embedding vector(1024),                                          -- é˜¿é‡Œäº‘ text-embedding-v3 (1024ç»´)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- åˆ›å»º HNSW ç´¢å¼•åŠ é€Ÿæœç´¢ï¼ˆæ¯” IVF æ›´å¿«ï¼‰
create index idx_product_embeddings_embedding_idx
  on public.product_embeddings
  using hnsw (embedding vector_cosine_ops)
  with (m = 16, ef_construction = 64);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **å…³è”è¡¨è®¾è®¡**ï¼šä¸ç›´æ¥ä¿®æ”¹ `products` è¡¨ï¼Œä¿æŒä¸šåŠ¡è¡¨çº¯å‡€
- **HNSW ç´¢å¼•**ï¼šä½¿ç”¨è¿‘ä¼¼æœ€è¿‘é‚»ç®—æ³•ï¼Œæœç´¢é€Ÿåº¦æ¯”ç²¾ç¡®åŒ¹é…å¿« 10-100 å€
- **è‡ªç„¶è¯­è¨€æ¸…æ´—**ï¼š`content` å­—æ®µå­˜å‚¨ç»“æ„åŒ–æ•°æ®è½¬æ¢åçš„è‡ªç„¶è¯­è¨€æè¿°

##### 3.2 å‘é‡æœç´¢å‡½æ•° (RPC)

```sql
create or replace function match_products (
  query_embedding vector(1024),
  match_threshold float default 0.5,
  match_count int default 5
)
returns table (
  id bigint,
  content text,
  similarity float,
  product_details jsonb
)
language plpgsql
as $$
begin
  return query
  select
    products.id,
    product_embeddings.content,
    1 - (product_embeddings.embedding <=> query_embedding) as similarity,
    to_jsonb(products.*) as product_details
  from product_embeddings
  inner join products on products.id = product_embeddings.product_id
  where 1 - (product_embeddings.embedding <=> query_embedding) > match_threshold
    and products.status = 'published'
  order by product_embeddings.embedding <=> query_embedding
  limit match_count;
end;
$$;

-- æˆæƒç»™ service_role
grant execute on function match_products to service_role;
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **ä½™å¼¦ç›¸ä¼¼åº¦**ï¼šä½¿ç”¨ `<=>` æ“ä½œç¬¦è®¡ç®—å‘é‡è·ç¦»ï¼Œè¿”å› 0-2 ä¹‹é—´çš„å€¼ï¼ˆè¶Šå°è¶Šç›¸ä¼¼ï¼‰
- **é˜ˆå€¼è¿‡æ»¤**ï¼š`match_threshold` æ§åˆ¶ç»“æœç›¸å…³æ€§ï¼ˆ0.5 = ä¸­ç­‰ç›¸å…³æ€§ï¼‰
- **JSONB è¾“å‡º**ï¼šç›´æ¥è¿”å›äº§å“çš„å®Œæ•´æ•°æ®ï¼Œå‡å°‘äºŒæ¬¡æŸ¥è¯¢

---

#### 4. CMS å†…å®¹è¡¨

##### 4.1 products - äº§å“è¡¨

```sql
create table public.products (
  id bigint generated by default as identity primary key,
  name jsonb not null default '{}',                                -- { cn: "äº§å“å", hk: "ç”¢å“å", en: "Product Name" }
  description jsonb,
  specs jsonb,                                                     -- è§„æ ¼å‚æ•°
  status varchar(20) default 'draft' check (status in ('draft', 'published', 'archived')),
  order int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  deleted_at timestamp with time zone
);
```

##### 4.2 posts - æ–°é—»/æ–‡ç« è¡¨

```sql
create table public.posts (
  id bigint generated by default as identity primary key,
  title jsonb not null,
  slug varchar(255) unique,
  content jsonb,
  excerpt jsonb,
  featured_image varchar(500),
  status varchar(20) default 'draft',
  published_at timestamp with time zone,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

##### 4.3 solutions - è§£å†³æ–¹æ¡ˆè¡¨

```sql
create table public.solutions (
  id bigint generated by default as identity primary key,
  title jsonb not null,
  description jsonb,
  icon varchar(100),
  order int default 0,
  status varchar(20) default 'draft',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

##### 4.4 inquiries - è¯¢ç›˜è¡¨

```sql
create table public.inquiries (
  id bigint generated by default as identity primary key,
  name varchar(255) not null,
  email varchar(255) not null,
  phone varchar(50),
  company varchar(255),
  message text not null,
  status varchar(20) default 'pending',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

---

#### 5. ç”¨æˆ·ç®¡ç†è¡¨

##### 5.1 profiles - ç”¨æˆ·èµ„æ–™è¡¨

```sql
create table public.profiles (
  id uuid references auth.users(id) on delete cascade primary key,
  email varchar(255),
  full_name varchar(255),
  avatar_url varchar(500),
  role varchar(20) default 'user' check (role in ('user', 'admin')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- å¯ç”¨ RLS (Row Level Security)
alter table public.profiles enable row level security;

-- ç­–ç•¥ï¼šæ‰€æœ‰äººå¯è¯»ï¼Œåªæœ‰æœ¬äººæˆ–ç®¡ç†å‘˜å¯å†™
create policy "Public profiles are viewable by everyone"
  on public.profiles for select
  using (true);

create policy "Users can insert their own profile"
  on public.profiles for insert
  with check (auth.uid() = id);

create policy "Users can update own profile"
  on public.profiles for update
  using (auth.uid() = id);
```

---

### æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.users     â”‚â”€â”€â”€â”   â”‚ chat_sessions   â”‚â”€â”€â”€â”   â”‚  chat_messages  â”‚
â”‚  (Supabase Auth)â”‚   â””â”€â”€â”‚ (user_id)       â”‚   â””â”€â”€â”‚ (session_id)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚       â”‚                 â”‚
                          â”‚ anonymous_user â”‚       â”‚                 â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚                        â”‚
                                   â”‚                        â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ ai_usage_stats  â”‚      â”‚ chat_feedback  â”‚
                          â”‚ (æ¯æ—¥ç»Ÿè®¡)       â”‚      â”‚ (è´¨é‡è¯„åˆ†)      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    products     â”‚â”€â”€â”€â”   â”‚product_embeddingsâ”‚
â”‚  (äº§å“ä¸»è¡¨)      â”‚   â””â”€â”€â”‚ (product_id)     â”‚
â”‚                 â”‚       â”‚ embedding vector â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    posts    â”‚  â”‚    solutions        â”‚  â”‚      inquiries         â”‚
â”‚ (æ–°é—»æ–‡ç« )   â”‚  â”‚ (è§£å†³æ–¹æ¡ˆ)           â”‚  â”‚ (è¯¢ç›˜è¡¨å•)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å¸¸ç”¨ SQL æŸ¥è¯¢ç¤ºä¾‹

#### 1. è·å–ç”¨æˆ·ä»Šæ—¥ Token ä½¿ç”¨é‡

```sql
-- ç™»å½•ç”¨æˆ·
SELECT
  date,
  total_tokens,
  message_count,
  session_count
FROM ai_usage_stats
WHERE user_id = auth.uid()
  AND date = current_date;

-- åŒ¿åç”¨æˆ·
SELECT
  date,
  total_tokens,
  message_count
FROM ai_usage_stats
WHERE anonymous_user_id = 'ç”¨æˆ·æŒ‡çº¹ID'
  AND date = current_date;
```

#### 2. è·å–ä¼šè¯å†å²ï¼ˆå«æ¶ˆæ¯ï¼‰

```sql
SELECT
  cs.id as session_id,
  cs.title,
  cs.model,
  cs.created_at,
  jsonb_agg(
    jsonb_build_object(
      'role', cm.role,
      'content', cm.content,
      'created_at', cm.created_at
    ) ORDER BY cm.created_at
  ) as messages
FROM chat_sessions cs
LEFT JOIN chat_messages cm ON cm.session_id = cs.id
WHERE cs.user_id = auth.uid()
  AND cs.deleted_at IS NULL
GROUP BY cs.id
ORDER BY cs.updated_at DESC
LIMIT 20;
```

#### 3. è®¡ç®—ä¼šè¯ Token æ¶ˆè€—

```sql
-- ä¼°ç®—è§„åˆ™ï¼ˆåŸºäº Qwen-Plusï¼‰
-- 1 Token â‰ˆ 1.5 ä¸ªè‹±æ–‡å•è¯ æˆ– 1 ä¸ªæ±‰å­—
-- è¾“å…¥ï¼š$0.0002 / 1k tokens
-- è¾“å‡ºï¼š$0.0006 / 1k tokens

SELECT
  cs.id,
  cs.title,
  COUNT(cm.id) as message_count,
  SUM(cm.tokens_estimate) as total_tokens,
  SUM(
    CASE
      WHEN cm.role = 'user' THEN cm.tokens_estimate * 0.0002 / 1000
      WHEN cm.role = 'assistant' THEN cm.tokens_estimate * 0.0006 / 1000
      ELSE 0
    END
  ) as estimated_cost_usd
FROM chat_sessions cs
LEFT JOIN chat_messages cm ON cm.session_id = cs.id
WHERE cs.id = :session_id
GROUP BY cs.id;
```

#### 4. ç”¨æˆ·åé¦ˆç»Ÿè®¡

```sql
SELECT
  cf.category,
  COUNT(*) as feedback_count,
  AVG(rating) as avg_rating
FROM chat_feedback cf
JOIN chat_messages cm ON cf.message_id = cm.id
JOIN chat_sessions cs ON cm.session_id = cs.id
WHERE cs.user_id = auth.uid()
GROUP BY cf.category
ORDER BY feedback_count DESC;
```

#### 5. äº§å“ç›¸ä¼¼åº¦æœç´¢ï¼ˆé€šè¿‡å‡½æ•°ï¼‰

```sql
-- å…ˆç”Ÿæˆé—®é¢˜å‘é‡
-- SELECT embedding FROM create_embedding('éœ€è¦ GPU æœåŠ¡å™¨çš„è§£å†³æ–¹æ¡ˆ');

-- ç„¶åæœç´¢
SELECT * FROM match_products(
  query_embedding => '[0.1, 0.2, ...]',  -- 1024 ç»´å‘é‡
  match_threshold => 0.5,
  match_count => 5
);
```

---

### Row Level Security (RLS) ç­–ç•¥

ä¸ºä¿æŠ¤ç”¨æˆ·éšç§ï¼Œå»ºè®®åœ¨æ ¸å¿ƒè¡¨ä¸Šå¯ç”¨ RLSï¼š

#### chat_sessions ç­–ç•¥

```sql
ALTER TABLE public.chat_sessions ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä¼šè¯
CREATE POLICY "Users can view own sessions"
  ON public.chat_sessions FOR SELECT
  USING (
    user_id = auth.uid() OR
    anonymous_user_id = current_setting('request.anonymous_id', true)
  );

CREATE POLICY "Users can create own sessions"
  ON public.chat_sessions FOR INSERT
  WITH CHECK (
    user_id = auth.uid() OR
    anonymous_user_id = current_setting('request.anonymous_id', true)
  );

CREATE POLICY "Users can update own sessions"
  ON public.chat_sessions FOR UPDATE
  USING (
    user_id = auth.uid() OR
    anonymous_user_id = current_setting('request.anonymous_id', true)
  );
```

#### chat_messages ç­–ç•¥

```sql
ALTER TABLE public.chat_messages ENABLE ROW LEVEL SECURITY;

-- é€šè¿‡ session_id æ§åˆ¶è®¿é—®
CREATE POLICY "Users can view messages in own sessions"
  ON public.chat_messages FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.chat_sessions
      WHERE chat_sessions.id = chat_messages.session_id
        AND (chat_sessions.user_id = auth.uid() OR
             chat_sessions.anonymous_user_id = current_setting('request.anonymous_id', true))
    )
  );
```

---

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ç­–ç•¥**
   - æ‰€æœ‰å¤–é”®å­—æ®µæ·»åŠ ç´¢å¼•
   - é«˜é¢‘æŸ¥è¯¢å­—æ®µï¼ˆå¦‚ `status`, `date`ï¼‰æ·»åŠ ç´¢å¼•
   - å‘é‡æœç´¢ä½¿ç”¨ HNSW ç´¢å¼•ï¼ˆæ¯” IVF æ›´å¿«ï¼‰

2. **åˆ†åŒºè¡¨**
   - `chat_messages` å¯æŒ‰ `created_at` åˆ†åŒºï¼Œæé«˜å†å²æ•°æ®æŸ¥è¯¢æ€§èƒ½
   - `ai_usage_stats` å¯æŒ‰ `date` åˆ†åŒºï¼Œä¾¿äºæ¸…ç†æ—§æ•°æ®

3. **ç¼“å­˜ç­–ç•¥**
   - ä½¿ç”¨ Supabase Edge Functions ç¼“å­˜é¢‘ç¹è®¿é—®çš„äº§å“æ•°æ®
   - AI å›ç­”å¯è€ƒè™‘çŸ­æœŸç¼“å­˜ï¼ˆç›¸åŒé—®é¢˜ 1 å°æ—¶å†…è¿”å›ç›¸åŒç­”æ¡ˆï¼‰

4. **å®šæœŸç»´æŠ¤**
   - å®šæœŸ `VACUUM ANALYZE` æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   - å½’æ¡£æˆ–åˆ é™¤è¶…è¿‡ 90 å¤©çš„åŒ¿åä¼šè¯æ•°æ®

---

## è‡ªåŠ¨åŒ–å‘é‡åŒ– (Edge Function)

ä¸ºäº†å®ç°"æ›´æ–°äº§å“è‡ªåŠ¨åŒæ­¥å‘é‡"ï¼Œæˆ‘ä»¬ä½¿ç”¨ Supabase Edge Functionã€‚

### åŠŸèƒ½è¯´æ˜

å½“ `products` è¡¨å‘ç”Ÿ `INSERT` æˆ– `UPDATE` æ—¶ï¼š
1. Webhook è‡ªåŠ¨è§¦å‘ Edge Function
2. Function æ¸…æ´— JSON æ•°æ®ä¸ºè‡ªç„¶è¯­è¨€
3. è°ƒç”¨é˜¿é‡Œäº‘ API ç”Ÿæˆå‘é‡
4. å†™å…¥ `product_embeddings` è¡¨

### ä»£ç å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`supabase/functions/embed-product/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { OpenAI } from 'https://esm.sh/openai@4.42.0'

serve(async (req) => {
  try {
    const { record, type } = await req.json()

    // DELETE æ“ä½œè·³è¿‡
    if (type === 'DELETE' || !record) {
      return new Response('Skipped', { status: 200 })
    }

    // 1. æ•°æ®æ¸…æ´—ï¼šJSON â†’ è‡ªç„¶è¯­è¨€
    const name = record.name?.cn || record.name?.hk || record.name?.en || 'æœªçŸ¥äº§å“'
    const specs = JSON.stringify(record.specs || {})
    const desc = record.description?.cn || record.description?.en || ''

    const content = `äº§å“åç§°: ${name}\nè§„æ ¼å‚æ•°: ${specs}\näº§å“æè¿°: ${desc}`

    // 2. è°ƒç”¨é˜¿é‡Œäº‘ç”Ÿæˆå‘é‡
    const openai = new OpenAI({
      apiKey: Deno.env.get('DASHSCOPE_API_KEY'),
      baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
    })

    const embedding = await openai.embeddings.create({
      model: 'text-embedding-v3',
      input: content.replace(/\n/g, ' '),
      dimensions: 1024,
    })

    // 3. å†™å…¥æ•°æ®åº“
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )

    await supabase.from('product_embeddings').upsert({
      product_id: record.id,
      content: content,
      embedding: embedding.data[0].embedding,
    })

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
    })

  } catch (error) {
    console.error('Embedding error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

### éƒ¨ç½²æ­¥éª¤

1. **åœ¨ Supabase é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ç¯å¢ƒå˜é‡**ï¼š
   - `DASHSCOPE_API_KEY`: ä½ çš„é˜¿é‡Œäº‘ API Key
   - `SUPABASE_URL`: é¡¹ç›® URL
   - `SUPABASE_SERVICE_ROLE_KEY`: Service Role Key

2. **éƒ¨ç½² Function**ï¼š
   ```bash
   supabase functions deploy embed-product
   ```

3. **é…ç½® Webhook**ï¼š
   - è¿›å…¥ Supabase Dashboard â†’ Database â†’ Webhooks
   - åˆ›å»ºæ–° Webhookï¼Œç›‘å¬ `products` è¡¨çš„ `INSERT` å’Œ `UPDATE`
   - ç›®æ ‡ URL: `https://your-project.supabase.co/functions/v1/embed-product`
   - ç¡®ä¿å‹¾é€‰ "Send only changed columns"

---

## åº”ç”¨å±‚å®ç° (Nuxt 3)

### 1. ç¯å¢ƒå˜é‡é…ç½®

**`.env` æ–‡ä»¶**ï¼š
```env
# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
SUPABASE_SECRET_KEY=your_supabase_service_role_key

# é˜¿é‡Œäº‘ç™¾ç‚¼
DASHSCOPE_API_KEY=your_dashscope_api_key
```

**`nuxt.config.ts` é…ç½®**ï¼š
```typescript
export default defineNuxtConfig({
  runtimeConfig: {
    // æœåŠ¡ç«¯ç§æœ‰é…ç½®
    dashscopeApiKey: process.env.DASHSCOPE_API_KEY,
    supabaseService: {
      url: process.env.SUPABASE_URL,
      key: process.env.SUPABASE_SECRET_KEY,
    },
    // å‰ç«¯å…¬å¼€é…ç½®
    public: {
      supabaseUrl: process.env.SUPABASE_URL,
      supabaseKey: process.env.SUPABASE_KEY,
    },
  },
})
```

### 2. åç«¯ API å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`server/api/ai-chat.ts`

```typescript
import { createOpenAI } from '@ai-sdk/openai'
import { streamText } from 'ai'
import { OpenAI } from 'openai'
import { createClient } from '@supabase/supabase-js'

export default defineEventHandler(async (event) => {
  const config = useRuntimeConfig()
  const { url, key } = config.supabaseService
  const apiKey = config.dashscopeApiKey

  if (!url || !key || !apiKey) {
    throw createError({ statusCode: 500, statusMessage: 'Missing AI Configuration' })
  }

  // åˆå§‹åŒ–å®¢æˆ·ç«¯
  const supabaseAdmin = createClient(url, key)
  const aliyun = createOpenAI({
    apiKey: apiKey,
    baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
  })
  const openaiForEmbed = new OpenAI({
    apiKey: apiKey,
    baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
  })

  // è§£æç”¨æˆ·è¾“å…¥
  const { messages } = await readBody(event)
  const lastMessage = messages[messages.length - 1].content

  try {
    // 1. ç”Ÿæˆé—®é¢˜å‘é‡
    const embeddingResp = await openaiForEmbed.embeddings.create({
      model: 'text-embedding-v3',
      input: lastMessage.replaceAll('\n', ' '),
      dimensions: 1024,
    })

    // 2. å‘é‡æœç´¢
    const { data: products } = await supabaseAdmin.rpc('match_products', {
      query_embedding: embeddingResp.data[0].embedding,
      match_threshold: 0.5,
      match_count: 5,
    })

    // 3. æ„å»ºä¸Šä¸‹æ–‡
    const contextBlock = products?.map((item: any) => {
      const raw = item.product_details
      const name = raw.name?.cn || raw.name?.hk || raw.name?.en || 'æœªå‘½åäº§å“'
      return `[äº§å“]: ${name}\n[AIæ‘˜è¦]: ${item.content}\n---`
    }).join('\n') || 'æœªæ‰¾åˆ°ç›¸å…³äº§å“'

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ç¡¬ä»¶ä¸“å®¶ (Supercore AI)ã€‚
è¯·åŸºäºä»¥ä¸‹äº§å“åº“å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœåº“é‡Œæ²¡æœ‰ï¼Œè¯·è¯´æ˜ã€‚
è¯·ç”¨ç¹ä½“ä¸­æ–‡(é¦™æ¸¯)æˆ–ç”¨æˆ·ä½¿ç”¨çš„è¯­è¨€å›ç­”ã€‚

ã€äº§å“åº“æ•°æ®ã€‘:
${contextBlock}`

    // 4. æµå¼ç”Ÿæˆ
    const result = await streamText({
      model: aliyun('qwen-plus'),
      messages: [
        { role: 'system', content: systemPrompt },
        ...messages,
      ],
      temperature: 0.3,
    })

    return result.toDataStreamResponse()

  } catch (e: any) {
    console.error('AI Chat Error:', e)
    throw createError({ statusCode: 500, statusMessage: e.message })
  }
})

### 3. å‰ç«¯ç»„ä»¶

**çŠ¶æ€ç®¡ç†** (`stores/chat.ts`)
- Pinia Store å¤„ç†ä¼šè¯åˆ—è¡¨åŒæ­¥
- è‡ªåŠ¨å¤„ç†ä¼šè¯åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤å’Œé‡å‘½å
- æ¶ˆæ¯å†å²è®°å½•ç®¡ç†

**å‰ç«¯ç»„ä»¶** (`components/ui/AiChat.vue`)
- é›†æˆ `useChatStore` ç»Ÿä¸€ç®¡ç†çŠ¶æ€
- Vercel AI SDK çš„ `useChat` hook å¤„ç†æµå¼è®¡ç®—
- Swiss Design é£æ ¼ UIï¼Œæ”¯æŒå¤šä¼šè¯ä¾§æ 
- `useSafeMarkdown` å®‰å…¨æ¸²æŸ“ Markdown å†…å®¹
- è‡ªåŠ¨æ»šåŠ¨ã€åŠ è½½åŠ¨ç”»ã€äº¤äº’åé¦ˆ
- **åŒ¿åç”¨æˆ·ç®¡ç†** (`composables/useAnonymousUser.ts`):
  - è‡ªåŠ¨ç”Ÿæˆå¹¶æŒä¹…åŒ–å”¯ä¸€æ ‡è¯†ã€‚
  - ç¡®ä¿å³ä½¿ç”¨æˆ·æœªç™»å½•ï¼Œä¹Ÿèƒ½è¿½è¸ªå…¶å¯¹è¯å†å²å’Œé…é¢æ¶ˆè€—ã€‚

### 4. AI ç®¡ç†ä¸æˆæœ¬æ§åˆ¶ (Administration)

**æœåŠ¡ç«¯é™åˆ¶** (`server/api/ai-chat.ts`):
- **Token ä¼°ç®—**: æ ¹æ® Qwen-Plus æ¨¡å‹æ ‡å‡†å¯¹ Prompt å’Œå“åº”è¿›è¡Œ Token è®¡ç®—ã€‚
- **æ¯æ—¥é™é¢**: æ¯ä¸ªç”¨æˆ·ï¼ˆå«åŒ¿åï¼‰æœ‰å›ºå®šçš„æ¯æ—¥ Token ç´¯è®¡é™é¢ï¼Œä¿æŠ¤åç«¯ API æˆæœ¬ã€‚
- **å¼‚å¸¸æ£€æµ‹**: å¼‚å¸¸é«˜é¢‘è¯·æ±‚è‡ªåŠ¨ç†”æ–­ã€‚

**ç®¡ç†åå°ç»Ÿè®¡** (`pages/admin/chat/analytics.vue`):
- **å®æ—¶çœ‹æ¿**: æ¥å…¥ ECharts å±•ç¤ºæ¯æ—¥ Token æ¶ˆè€—è¶‹åŠ¿ã€æ¶ˆæ¯æ•°é‡åŠå“åº”è€—æ—¶åˆ†å¸ƒã€‚
- **è´¢åŠ¡æˆæœ¬**: è‡ªåŠ¨å°† Token æ¢ç®—ä¸ºé¢„ä¼°ç¾é‡‘æˆæœ¬ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚
- **ä¼šè¯æº¯æº**: æ”¯æŒåœ¨åå°ç›´æ¥æŸ¥çœ‹ä»»æ„ä¼šè¯çš„å®Œæ•´æ˜ç»†ã€‚

```vue
<script setup lang="ts">
import { useChat } from 'ai/vue'
import { ref, watch, nextTick } from 'vue'
import { marked } from 'marked'

const isOpen = ref(false)
const scrollContainer = ref<HTMLDivElement | null>(null)

const { messages, input, handleSubmit, isLoading } = useChat({
  api: '/api/ai-chat'
})

marked.setOptions({ breaks: true, gfm: true })

// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
watch(messages, async () => {
  await nextTick()
  if (scrollContainer.value) {
    scrollContainer.value.scrollTop = scrollContainer.value.scrollHeight
  }
}, { deep: true })
</script>

<template>
  <div class="fixed bottom-6 right-6 z-50">
    <!-- Chat Window -->
    <div v-if="isOpen" class="w-[350px] h-[500px] bg-white rounded-xl shadow-xl flex flex-col">
      <!-- Header -->
      <div class="p-4 bg-blue-600 text-white flex justify-between">
        <span>Supercore AI</span>
        <button @click="isOpen = false">âœ•</button>
      </div>

      <!-- Messages -->
      <div ref="scrollContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div v-for="m in messages" :key="m.id"
             :class="['p-3 rounded-lg max-w-[85%]',
                      m.role === 'user' ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-100 mr-auto']">
          <div v-if="m.role === 'assistant'" v-html="marked(m.content)" />
          <div v-else>{{ m.content }}</div>
        </div>
      </div>

      <!-- Input -->
      <form @submit="handleSubmit" class="p-3 border-t flex gap-2">
        <input v-model="input" placeholder="è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ï¼Ÿ" />
        <button type="submit" :disabled="isLoading">Send</button>
      </form>
    </div>

    <!-- Toggle Button -->
    <button @click="isOpen = !isOpen">ğŸ’¬</button>
  </div>
</template>
```

---

## è¸©å‘å®å½•

### å‘ 1ï¼šNuxt "å¹½çµæŠ¥é”™" (`replace` of undefined)

**ç°è±¡**ï¼š
ä¿®æ”¹ `.env` æˆ– `nuxt.config.ts` åï¼Œé¡µé¢ç™½å±ï¼Œæ§åˆ¶å°æŠ¥é”™ï¼š
```
Cannot read properties of undefined (reading 'replace')
```

**åŸå› **ï¼š
Nuxt çš„é”™è¯¯é¡µé¢æ¸²æŸ“å™¨ (`youch`) å› ç¼“å­˜é—®é¢˜å´©æºƒäº†ã€‚

**è§£å†³**ï¼š
```bash
# 1. åœæ­¢æœåŠ¡
# 2. åˆ é™¤ç¼“å­˜
rm -rf .nuxt
rm -rf node_modules/.cache

# 3. é‡å¯
npm run dev
```

### å‘ 2ï¼šç‰ˆæœ¬ä¾èµ–åœ°ç‹±

**ç°è±¡**ï¼š
`import { useChat } from 'ai/vue'` æŠ¥é”™æ‰¾ä¸åˆ°æ¨¡å—ã€‚

**åŸå› **ï¼š
Vercel AI SDK æ›´æ–°æå¿«ï¼Œv3 å’Œ v4 API ä¸å…¼å®¹ã€‚

**è§£å†³**ï¼š
é”å®šç‰ˆæœ¬ä½¿ç”¨ `ai` (3.x)ï¼š
```json
{
  "dependencies": {
    "ai": "^3.1.37",
    "@ai-sdk/openai": "^1.0.0",
    "openai": "^4.42.0"
  }
}
```

### å‘ 3ï¼šSupabase è·¯ç”±æ‹¦æˆª

**ç°è±¡**ï¼š
API æ¥å£åœ¨ Postman èƒ½é€šï¼Œä½†æµè§ˆå™¨è°ƒç”¨è¿”å› 302 æˆ– HTMLã€‚

**åŸå› **ï¼š
`@nuxtjs/supabase` æ¨¡å—å¼€å¯äº†å…¨å±€è·¯ç”±ä¿æŠ¤ï¼Œæœªç™»å½•ç”¨æˆ·è¢«æ‹¦æˆªã€‚

**è§£å†³**ï¼š
åœ¨ `nuxt.config.ts` ä¸­æ·»åŠ ç™½åå•ï¼š
```typescript
supabase: {
  redirectOptions: {
    exclude: [
      '/api/ai-chat',
      '/api/products/public',
      // å…¶ä»–å…¬å¼€ API...
    ]
  }
}
```

### å‘ 4ï¼šå‘é‡ç»´åº¦é”™è¯¯

**ç°è±¡**ï¼š
æ’å…¥å‘é‡æ—¶æŠ¥é”™ `vector dimension must be 1024`ã€‚

**åŸå› **ï¼š
é˜¿é‡Œäº‘ `text-embedding-v3` ç”Ÿæˆçš„æ˜¯ 1024 ç»´å‘é‡ï¼Œä¸æ˜¯ OpenAI çš„ 1536 ç»´ã€‚

**è§£å†³**ï¼š
ç¡®ä¿æ•°æ®åº“è¡¨å’Œå‡½æ•°éƒ½ä½¿ç”¨ `vector(1024)`ã€‚

---

## éƒ¨ç½²æ¸…å•

### æœ¬åœ°å¼€å‘

1. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   npm install
   ```

2. **é…ç½® `.env`**ï¼š
   ```env
   SUPABASE_URL=xxx
   SUPABASE_KEY=xxx
   SUPABASE_SECRET_KEY=xxx
   DASHSCOPE_API_KEY=xxx
   ```

3. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**ï¼š
   ```bash
   npm run dev
   ```

### ç”Ÿäº§éƒ¨ç½²

1. **éƒ¨ç½² Edge Function**ï¼š
   ```bash
   supabase functions deploy embed-product
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆåœ¨éƒ¨ç½²å¹³å°ï¼‰ï¼š
   - `SUPABASE_URL`
   - `SUPABASE_KEY`
   - `SUPABASE_SECRET_KEY`
   - `DASHSCOPE_API_KEY`

3. **æ„å»ºå¹¶éƒ¨ç½²**ï¼š
   ```bash
   npm run build
   # éƒ¨ç½²åˆ° Vercel / Netlify ç­‰
   ```

---

## æ€»ç»“

è¿™å¥—æ¶æ„éå¸¸é€‚åˆä¸ªäººå¼€å‘è€…æˆ–ä¸­å°é¡¹ç›®ï¼š

âœ… **æˆæœ¬ä½**ï¼šSupabase å…è´¹é¢åº¦ + é˜¿é‡Œç™¾ç‚¼æ¯” OpenAI ä¾¿å®œ 70%+

âœ… **è‡ªåŠ¨åŒ–**ï¼šé€šè¿‡ Edge Function å®ç°æ•°æ®åŒæ­¥è‡ªåŠ¨åŒ–

âœ… **å¼€å‘ä½“éªŒ**ï¼šNuxt 3 å…¨æ ˆå¼€å‘é¡ºæ»‘ï¼ŒTypeScript ç±»å‹å®‰å…¨

âš ï¸ **æ³¨æ„ç‚¹**ï¼š
- é…ç½®æ–‡ä»¶æ”¹åŠ¨åè®°å¾—æ¸…ç¼“å­˜
- ç‰ˆæœ¬ä¾èµ–è¦é”å®šï¼Œé¿å…è‡ªåŠ¨å‡çº§
- API è·¯ç”±è¦åŠ å…¥ Supabase ç™½åå•

---

**å‚è€ƒèµ„æº**ï¼š
- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [é˜¿é‡Œäº‘ç™¾ç‚¼æ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)
- [pgvector æ–‡æ¡£](https://github.com/pgvector/pgvector)
