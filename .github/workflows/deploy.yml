name: Deploy Nuxt to Server

on:
  push:
    branches: [ "latest" ]  # ⚠️ 再次确认你的分支名是 main 还是 latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 70m
          script: |
            # 1. 进入项目目录
            cd /root/my-nuxt-app
            
            # 2. 【关键】强制同步 GitHub 代码
            # 这会删除服务器上所有手动修改（包括你刚才 nano 写的文件），确保和 GitHub 一致
            git fetch --all
            git reset --hard origin/latest  # ⚠️ 如果分支是 latest 这里也要改
            git pull origin latest          # ⚠️ 如果分支是 latest 这里也要改
            
            # 3. 重新构建 Docker 镜像
            docker build -t my-nuxt-app .
            
            # 4. 停止并删除旧容器
            docker stop nuxt-web || true
            docker rm nuxt-web || true
            
            # 5. 启动新容器 (注入 GitHub Secrets)
            docker run -d \
              --name nuxt-web \
              --restart=always \
              -p 3000:3000 \
              -e NUXT_PUBLIC_SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
              -e NUXT_PUBLIC_SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
              -e SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
              -e SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
              -e SUPABASE_SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}" \
              my-nuxt-app
              
            # 6. 清理垃圾
            docker image prune -f