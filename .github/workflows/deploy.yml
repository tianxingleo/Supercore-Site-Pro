name: Deploy Nuxt to Server

on:
  push:
    branches: [ "latest" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 70m # å»¶é•¿è¶…æ—¶æ—¶é—´
          script: |
            # =================================================
            # 1. æš‚æ—¶å…³é—­ Supabase ä»¥é‡Šæ”¾å†…å­˜ç»™ Nuxt æ„å»º
            # =================================================
            echo "ğŸ›‘ Stopping Supabase to free up memory..."
            # å‡è®¾ä½ çš„ supabase docker-compose æ–‡ä»¶åœ¨ /root/supabase/docker
            # å¦‚æœä¸æ˜¯è¿™ä¸ªè·¯å¾„ï¼Œè¯·ä¿®æ”¹ï¼ï¼ï¼
            cd /root/supabase/docker
            docker compose stop

            # =================================================
            # 2. æ›´æ–°ä»£ç å¹¶æ„å»º Nuxt
            # =================================================
            echo "â¬‡ï¸ Pulling code..."
            cd /root/my-nuxt-app
            git fetch --all
            git reset --hard origin/latest
            git pull origin latest

            echo "ğŸ—ï¸ Building Nuxt Docker Image..."
            # è¿™é‡Œçš„æ„å»ºç°åœ¨ç‹¬å æœåŠ¡å™¨èµ„æºï¼Œåº”è¯¥ä¼šå¾ˆå¿«
            docker build -t my-nuxt-app .

            # =================================================
            # 3. é‡å¯ Supabase (æ„å»ºå®Œæˆåç«‹åˆ»æ¢å¤æ•°æ®åº“)
            # =================================================
            echo "âœ… Build done. Restarting Supabase..."
            cd /root/supabase/docker
            docker compose start

            # ç­‰å¾…å‡ ç§’ç¡®ä¿æ•°æ®åº“å‡†å¤‡å¥½ (å¯é€‰)
            sleep 10

            # =================================================
            # 4. é‡æ–°å¯åŠ¨ Nuxt å®¹å™¨
            # =================================================
            echo "ğŸš€ Restarting Nuxt App..."
            docker stop nuxt-web || true
            docker rm nuxt-web || true

            docker run -d \
              --name nuxt-web \
              --restart=always \
              -p 3000:3000 \
              --network host \
              -e NUXT_PUBLIC_SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
              -e NUXT_PUBLIC_SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
              -e SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
              -e SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
              -e SUPABASE_SECRET_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}" \
              my-nuxt-app

            docker image prune -f
